<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!--
        TEMPLATES HTML PARA EL FRONTEND DE PUNTO DE INICIO
        ===================================================

        Estos templates definen las páginas HTML que se renderizan
        desde el controlador HTTP.
        -->

        <!-- Página de apertura de caja -->
        <template id="cash_opening_page" name="Cash Opening Page">
            <t t-call="web.layout">
                <t t-set="head">
                    <t t-call-assets="web.assets_backend" t-js="false"/>
                </t>

                <div class="container-fluid h-100 d-flex align-items-center justify-content-center bg-light">
                    <div class="card shadow-lg" style="max-width: 600px; width: 100%;">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="fa fa-money me-2"/>
                                Apertura de Caja - Punto de Inicio
                            </h4>
                        </div>
                        <div class="card-body p-4">
                            <div class="alert alert-info">
                                <strong><t t-esc="config.name"/></strong><br/>
                                <small>Sesión: <t t-esc="session.name"/></small>
                            </div>

                            <p class="text-muted mb-4">
                                Para iniciar la sesión, ingresa el monto inicial de efectivo en la caja.
                            </p>

                            <form id="cashOpeningForm" method="post" onsubmit="return false;">
                                <div class="mb-3">
                                    <label for="cash_amount" class="form-label">
                                        <strong>Monto Inicial de Efectivo</strong>
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text">$</span>
                                        <input
                                            type="number"
                                            class="form-control"
                                            id="cash_amount"
                                            name="cash_amount"
                                            step="0.01"
                                            min="0"
                                            value="0.00"
                                            required="required"
                                            autofocus="autofocus"
                                            style="font-size: 1.5rem; font-weight: 600; text-align: center;"
                                        />
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="notes" class="form-label">
                                        <strong>Notas u Observaciones</strong>
                                    </label>
                                    <textarea
                                        class="form-control"
                                        id="notes"
                                        name="notes"
                                        rows="3"
                                        placeholder="Observaciones opcionales..."
                                    />
                                </div>

                                <div class="d-grid gap-2">
                                    <button
                                        type="button"
                                        class="btn btn-primary btn-lg"
                                        onclick="openSession()"
                                    >
                                        <i class="fa fa-play me-2"/>
                                        Iniciar Sesión
                                    </button>
                                    <a href="/web#action=punto_inicio.action_punto_inicio_dashboard" class="btn btn-secondary">
                                        <i class="fa fa-arrow-left me-2"/>
                                        Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <script type="text/javascript">
                    async function openSession() {
                        const cashAmount = parseFloat(document.getElementById('cash_amount').value) || 0;
                        const notes = document.getElementById('notes').value || '';
                        const sessionId = <t t-esc="session.id"/>;

                        const button = event.target;
                        button.disabled = true;
                        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Iniciando...';

                        try {
                            // Llamar al backend para establecer el monto inicial
                            const response = await fetch('/web/dataset/call_kw', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: {
                                        model: 'pos.session',
                                        method: 'set_cashbox_opening',
                                        args: [sessionId],
                                        kwargs: {
                                            cashbox_start: cashAmount,
                                            notes: notes,
                                        },
                                    },
                                }),
                            });

                            const result = await response.json();

                            if (result.error) {
                                throw new Error(result.error.data.message || 'Error al abrir sesión');
                            }

                            // Abrir la sesión
                            const openResponse = await fetch('/web/dataset/call_kw', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: {
                                        model: 'pos.session',
                                        method: 'action_pos_session_open',
                                        args: [[sessionId]],
                                        kwargs: {},
                                    },
                                }),
                            });

                            const openResult = await openResponse.json();

                            if (openResult.error) {
                                throw new Error(openResult.error.data.message || 'Error al abrir sesión');
                            }

                            // Redirigir al frontend
                            window.location.href = `/punto_inicio/ui?session_id=${sessionId}`;

                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error al abrir la sesión: ' + error.message);
                            button.disabled = false;
                            button.innerHTML = '<i class="fa fa-play me-2"></i>Iniciar Sesión';
                        }
                    }
                </script>

                <t t-call-assets="web.assets_backend" t-js="true"/>
            </t>
        </template>

        <!-- Página principal del frontend -->
        <template id="punto_inicio_ui" name="Punto de Inicio UI">
            <t t-call="web.layout">
                <t t-set="head_web" t-value="true"/>
                <t t-set="head">
                    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
                    <t t-call-assets="web.assets_backend" t-css="true"/>
                    <style>
                        /* Ocultar navbar de Odoo */
                        .o_main_navbar {
                            display: none !important;
                        }
                        #punto_inicio_app {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            z-index: 9999;
                            background: #f0f0f0;
                        }
                        /* Dropdown menu */
                        .dropdown-menu.show {
                            display: block;
                        }
                        /* Modal backdrop */
                        .modal-backdrop-custom {
                            display: none;
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.5);
                            z-index: 10000;
                        }
                        .modal-backdrop-custom.show {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                    </style>
                </t>

                <div id="punto_inicio_app" style="height: 100vh; width: 100vw;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="text-muted">Cargando Punto de Inicio...</p>
                        </div>
                    </div>
                </div>

                <script type="text/javascript">
                    (function() {
                        'use strict';

                        // Esperar a que el DOM y Odoo estén listos
                        document.addEventListener('DOMContentLoaded', function() {
                            setTimeout(function() {
                                const appDiv = document.getElementById('punto_inicio_app');
                                if (!appDiv) {
                                    console.error('No se encontró el contenedor de la app');
                                    return;
                                }

                                // Crear contenido básico de la aplicación
                                const sessionId = <t t-esc="session_id"/>;
                                const sessionName = '<t t-esc="session.name"/>';
                                const configName = '<t t-esc="config.name"/>';
                                const cashStart = <t t-esc="session.cash_register_balance_start or 0"/>;

                                appDiv.innerHTML = `
                                    <div class="d-flex flex-column h-100">
                                        <!-- Header con clases Bootstrap -->
                                        <div class="bg-white border-bottom d-flex align-items-center justify-content-between px-3 py-2">
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="btn btn-primary rounded-circle" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fa fa-home"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">${configName}</div>
                                                    <small class="text-muted">${sessionName}</small>
                                                </div>
                                            </div>

                                            <div class="d-flex align-items-center gap-2">
                                                <button class="btn btn-light position-relative">
                                                    <i class="fa fa-list-alt"></i>
                                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
                                                </button>

                                                <div class="dropdown">
                                                    <button class="btn btn-light" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" onclick="toggleDropdown()">
                                                        <i class="fa fa-bars"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end" id="mainDropdown" aria-labelledby="dropdownMenuButton">
                                                        <li><a class="dropdown-item" href="#" onclick="openCloseSessionModal(); return false;">
                                                            <i class="fa fa-sign-out me-2"></i>Cerrar Sesión
                                                        </a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Main content con clases Bootstrap -->
                                        <div class="flex-grow-1 p-4 bg-light overflow-auto">
                                            <div class="container-fluid">
                                                <div class="card mb-4 shadow-sm">
                                                    <div class="card-header bg-white">
                                                        <h5 class="mb-0">Información de Sesión</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <p><strong>Sesión:</strong> ${sessionName}</p>
                                                                <p><strong>Punto de Inicio:</strong> ${configName}</p>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <p><strong>Estado:</strong> <span class="badge bg-success">Abierta</span></p>
                                                                <p><strong>Efectivo Inicial:</strong> $${cashStart.toFixed(2)}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="card shadow-sm">
                                                    <div class="card-body text-center py-5">
                                                        <i class="fa fa-check-circle text-success mb-3" style="font-size: 4rem;"></i>
                                                        <h3>Sesión Iniciada Correctamente</h3>
                                                        <p class="text-muted mb-4">La sesión de Punto de Inicio está activa y lista para operar.</p>
                                                        <div class="alert alert-info">
                                                            <i class="fa fa-info-circle me-2"></i>
                                                            <strong>Próximos pasos:</strong> Esta es la interfaz básica de Punto de Inicio.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Footer -->
                                        <div class="bg-white border-top p-3 text-center text-muted">
                                            <small>Punto de Inicio v1.0.0 - Sesión ID: ${sessionId}</small>
                                        </div>
                                    </div>

                                    <!-- Modal Bootstrap -->
                                    <div class="modal-backdrop-custom" id="closeSessionModal">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-header bg-danger text-white">
                                                    <h5 class="modal-title">
                                                        <i class="fa fa-sign-out me-2"></i>Cierre de Caja
                                                    </h5>
                                                    <button type="button" class="btn-close btn-close-white" onclick="closeModal()" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="alert alert-warning">
                                                        <i class="fa fa-exclamation-triangle me-2"></i>
                                                        <strong>¡Atención!</strong> Estás por cerrar la sesión de caja.
                                                    </div>

                                                    <div class="mb-3">
                                                        <p><strong>Sesión:</strong> ${sessionName}</p>
                                                        <p><strong>Efectivo Inicial:</strong> $${cashStart.toFixed(2)}</p>
                                                    </div>

                                                    <form id="closeSessionForm">
                                                        <div class="mb-3">
                                                            <label for="cash_end_amount" class="form-label fw-bold">Efectivo Final en Caja</label>
                                                            <div class="input-group input-group-lg">
                                                                <span class="input-group-text">$</span>
                                                                <input type="number" class="form-control text-center" id="cash_end_amount"
                                                                       step="0.01" min="0" value="0.00" required="required" />
                                                            </div>
                                                            <small class="text-muted">Ingresa el monto total de efectivo al cierre</small>
                                                        </div>

                                                        <div class="mb-3">
                                                            <label for="close_notes" class="form-label fw-bold">Notas de Cierre</label>
                                                            <textarea class="form-control" id="close_notes" rows="3"
                                                                      placeholder="Observaciones opcionales del cierre..."></textarea>
                                                        </div>
                                                    </form>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                                                        <i class="fa fa-times me-1"></i>Cancelar
                                                    </button>
                                                    <button type="button" class="btn btn-danger" onclick="closeSession()">
                                                        <i class="fa fa-sign-out me-1"></i>Cerrar Sesión
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }, 100);
                        });

                        // Función para toggle del dropdown usando Bootstrap
                        window.toggleDropdown = function() {
                            const dropdown = document.getElementById('mainDropdown');
                            dropdown.classList.toggle('show');
                        };

                        // Cerrar dropdown al hacer click fuera
                        document.addEventListener('click', function(event) {
                            const dropdown = document.querySelector('.dropdown');
                            if (dropdown &amp;&amp; !dropdown.contains(event.target)) {
                                document.getElementById('mainDropdown').classList.remove('show');
                            }
                        });

                        // Función para abrir el modal de cierre de sesión
                        window.openCloseSessionModal = function() {
                            document.getElementById('mainDropdown').classList.remove('show');
                            document.getElementById('closeSessionModal').classList.add('show');
                        };

                        // Función para cerrar el modal
                        window.closeModal = function() {
                            document.getElementById('closeSessionModal').classList.remove('show');
                        };

                        // Función para cerrar la sesión
                        window.closeSession = async function() {
                            const cashEndAmount = parseFloat(document.getElementById('cash_end_amount').value) || 0;
                            const closeNotes = document.getElementById('close_notes').value || '';
                            const sessionId = <t t-esc="session_id"/>;

                            const closeButton = event.target;
                            closeButton.disabled = true;
                            closeButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cerrando...';

                            try {
                                // Paso 1: Establecer el monto final de caja
                                const setCashResponse = await fetch('/web/dataset/call_kw', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        jsonrpc: '2.0',
                                        method: 'call',
                                        params: {
                                            model: 'pos.session',
                                            method: 'set_cashbox_closing',
                                            args: [sessionId],
                                            kwargs: {
                                                cashbox_end: cashEndAmount,
                                                notes: closeNotes,
                                            },
                                        },
                                    }),
                                });

                                const setCashResult = await setCashResponse.json();

                                if (setCashResult.error) {
                                    throw new Error(setCashResult.error.data.message || 'Error al establecer monto final');
                                }

                                // Paso 2: Cerrar la sesión
                                const closeResponse = await fetch('/web/dataset/call_kw', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        jsonrpc: '2.0',
                                        method: 'call',
                                        params: {
                                            model: 'pos.session',
                                            method: 'action_pos_session_closing_control',
                                            args: [[sessionId]],
                                            kwargs: {},
                                        },
                                    }),
                                });

                                const closeResult = await closeResponse.json();

                                if (closeResult.error) {
                                    throw new Error(closeResult.error.data.message || 'Error al cerrar sesión');
                                }

                                // Redirigir al dashboard
                                window.location.href = '/web#action=punto_inicio.action_punto_inicio_dashboard';

                            } catch (error) {
                                console.error('Error:', error);
                                alert('Error al cerrar la sesión: ' + error.message);
                                closeButton.disabled = false;
                                closeButton.innerHTML = '<i class="fa fa-sign-out me-1"></i>Cerrar Sesión';
                            }
                        };
                    })();
                </script>

                <t t-call-assets="web.assets_backend" t-js="true"/>
            </t>
        </template>

        <!-- Página de error -->
        <template id="error_page" name="Error Page">
            <t t-call="web.layout">
                <div class="container-fluid h-100 d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <i class="fa fa-exclamation-triangle text-danger mb-4" style="font-size: 5rem;"/>
                        <h2 t-esc="error_title"/>
                        <p class="text-muted" t-esc="error_message"/>
                        <a href="/web#action=punto_inicio.action_punto_inicio_dashboard" class="btn btn-primary mt-3">
                            <i class="fa fa-arrow-left me-2"/>
                            Volver al Dashboard
                        </a>
                    </div>
                </div>
            </t>
        </template>

    </data>
</odoo>